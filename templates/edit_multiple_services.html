<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Multiple Services</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/service_styles.css') }}">
    <style>
        .header {
            background-color: #2f276f;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        .back-button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .service-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .form-column {
            display: inline-block;
            width: 48%;
            vertical-align: top;
            padding: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .form-group textarea {
            resize: vertical;
        }
        button[type="submit"] {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .flash-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .flash-message.success {
            background-color: #d4edda;
            color: #155724;
        }
        .flash-message.danger {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Edit Multiple Services (Ticket ID: {{ ticket_id }})</h1>
        <button class="back-button" onclick="window.history.back()">Back</button>
    </div>

    <div class="form-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash-message {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data">
            {% for service in services %}
                <div class="service-section">
                    <h3>Service ID: {{ service.service_id }} (Asset ID: {{ service.asset_id }})</h3>
                    <div class="form-column">
                        <div class="form-group">
                            <label for="technician_name_{{ service.service_id }}">Technician Name:</label>
                            <select name="technician_name_{{ service.service_id }}" id="technician_name_{{ service.service_id }}" required onchange="updateTechnicianId('{{ service.service_id }}')">
                                <option value="">Select Technician</option>
                                {% for tech in technicians %}
                                    <option value="{{ tech.technician_name }}" data-technician-id="{{ tech.technician_id }}"
                                            {% if tech.technician_name == service.technician_name %}selected{% endif %}>
                                        {{ tech.technician_name }}
                                    </option>
                                {% endfor %}
                                <option value="add_new_technician" style="color: blue; font-weight: bold;">+ Add New Technician</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="technician_id_{{ service.service_id }}">Technician ID:</label>
                            <input type="text" name="technician_id_{{ service.service_id }}" id="technician_id_{{ service.service_id }}"
                                   value="{{ service.technician_id }}" readonly required>
                        </div>

                        <div class="form-group">
                            <label for="warranty_type_{{ service.service_id }}">Warranty Type:</label>
                            <select name="warranty_type_{{ service.service_id }}" id="warranty_type_{{ service.service_id }}" required>
                                <option value="" {% if not service.warranty_type %}selected{% endif %}>Select Warranty Type</option>
                                <option value="In Warranty" {% if service.warranty_type == 'In Warranty' %}selected{% endif %}>In Warranty</option>
                                <option value="Out of Warranty" {% if service.warranty_type == 'Out of Warranty' %}selected{% endif %}>Out of Warranty</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-column">
                        <div class="form-group">
                            <label for="work_done_{{ service.service_id }}">Work Done:</label>
                            <textarea name="work_done_{{ service.service_id }}" id="work_done_{{ service.service_id }}" rows="4" required>{{ service.work_done }}</textarea>
                        </div>

                        <div class="form-group">
                            <label for="next_service_date_{{ service.service_id }}">Next Service Date:</label>
                            <input type="date" name="next_service_date_{{ service.service_id }}" id="next_service_date_{{ service.service_id }}"
                                   value="{{ service.next_service_date if service.next_service_date else '' }}">
                        </div>

                        <div class="form-group">
                            <label for="service_charge_{{ service.service_id }}">Service Charge:</label>
                            <input type="number" name="service_charge_{{ service.service_id }}" id="service_charge_{{ service.service_id }}"
                                   value="{{ service.service_charge if service.service_charge else '' }}" step="0.01">
                        </div>

                        <div class="form-group">
                            <label for="service_case_id_{{ service.service_id }}">Service Case ID (Optional):</label>
                            <input type="text" name="service_case_id_{{ service.service_id }}" id="service_case_id_{{ service.service_id }}"
                                   value="{{ service.service_case_id if service.service_case_id else '' }}">
                        </div>

                        <div class="form-group">
                            <label for="remarks_{{ service.service_id }}">Remarks:</label>
                            <textarea name="remarks_{{ service.service_id }}" id="remarks_{{ service.service_id }}" rows="3">{{ service.remarks if service.remarks else '' }}</textarea>
                        </div>

                        <div class="form-group">
                            <label for="service_bill_{{ service.service_id }}">Service Bill Upload (Multiple Files):</label>
                            <input type="file" name="service_bill_{{ service.service_id }}" id="service_bill_{{ service.service_id }}"
                                   multiple accept=".png,.jpg,.jpeg,.gif,.pdf,.docx">
                            {% if service.service_bill_path %}
                                <p>Existing Files: {{ service.service_bill_path }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}

            <button type="submit">Save Changes</button>
        </form>
    </div>

    <script>
        function updateTechnicianId(serviceId) {
            const select = document.getElementById(`technician_name_${serviceId}`);
            const selectedOption = select.options[select.selectedIndex];
            const technicianId = selectedOption.getAttribute('data-technician-id');
            const technicianName = selectedOption.value;

            if (technicianName === 'add_new_technician') {
                // Primary approach: Use fetch
                fetch('/save_form_state_technician', {
                    method: 'POST',
                    body: new FormData(document.querySelector('form'))
                })
                .then(response => {
                    if (!response.ok) {
                        response.text().then(text => {
                            console.error('Fetch failed with status:', response.status);
                            console.error('Response text:', text);
                        });
                        throw new Error('Failed to save form state');
                    }
                    if (response.redirected) {
                        window.location.href = response.url;
                    }
                })
                .catch(error => {
                    console.error('Error saving form state:', error);
                    // Fallback: Traditional form submission
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = '/save_form_state_technician';
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'ticket_id';
                    input.value = '{{ ticket_id }}';
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                });
            } else if (technicianId) {
                document.getElementById(`technician_id_${serviceId}`).value = technicianId;
            } else {
                document.getElementById(`technician_id_${serviceId}`).value = '';
            }
        }
    </script>
</body>
</html>